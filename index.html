<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Formação (com Banco de Dados)</title>
    <!-- Inclui a fonte Inter do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Inclui a biblioteca de ícones Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9I4/G1/Pq16fVzKq80fP9nL/C1I9qEwT659A1q" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Inclui o framework Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
    <div id="login-container" class="w-full max-w-sm bg-white shadow-xl rounded-2xl p-6 sm:p-8 lg:p-10 border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-800 mb-6">Login</h1>
        <form id="login-form" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Utilizador</label>
                <input type="text" id="username" name="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Palavra-Passe</label>
                <input type="password" id="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105">
                Entrar
            </button>
        </form>
        <button id="collaborator-button" class="w-full mt-4 flex justify-center py-3 px-4 border border-gray-300 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105">
            Entrar como Colaborador
        </button>
    </div>

    <div id="form-container" class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 lg:p-10 border border-gray-200 hidden">
        <!-- Título do Formulário -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-800 mb-2">Ficha de Formação Inicial</h1>
        <p class="text-md sm:text-lg text-center text-gray-500 mb-8">Preencha as informações para o novo colaborador remoto.</p>
        
        <form id="training-form" class="space-y-8">
            <!-- Seção 1: Dados do Colaborador -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-user-circle mr-2"></i>Dados do Colaborador</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" id="name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="admission-date" class="block text-sm font-medium text-gray-700">Admissão</label>
                        <input type="date" id="admission-date" name="admission-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="sector" class="block text-sm font-medium text-gray-700">Setor</label>
                        <input type="text" id="sector" name="sector" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="position" class="block text-sm font-medium text-gray-700">Cargo</label>
                        <input type="text" id="position" name="position" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="training-period" class="block text-sm font-medium text-gray-700">Período de Formação</label>
                        <input type="text" id="training-period" name="training-period" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border" placeholder="Ex: 09/07/2025 – 15/07/2025">
                    </div>
                </div>
            </div>

            <!-- Seção 2: Objetivo da Formação -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-bullseye mr-2"></i>Objetivo da Formação</h2>
                <p class="text-gray-600 leading-relaxed text-sm sm:text-base">Garantir a integração adequada do(a) colaborador(a), alinhamento às normas da empresa, segurança e domínio das atividades essenciais da função.</p>
            </div>

            <!-- Seção 3: Corpo da Formação -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-clipboard-list mr-2"></i>Corpo da Formação</h2>
                <div id="training-topics-list" class="space-y-3">
                    <!-- Checkboxes de formação serão carregados dinamicamente via JS -->
                    <p class="text-center text-gray-500">A carregar tópicos de formação...</p>
                </div>
            </div>

            <!-- Seção 4: Checklist de Entrega de Itens -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-check-circle mr-2"></i>Checklist de Entrega de Itens</h2>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <div class="flex items-center flex-shrink-0">
                            <input id="item-1-delivered" type="checkbox" name="item-delivered-cartao" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="item-1-delivered" class="text-sm font-medium text-gray-700">Cartão de ponto / Acesso</label>
                        </div>
                        <input type="text" name="item-delivered-by-cartao" placeholder="Entregue por quem?" class="mt-2 sm:mt-0 sm:ml-4 flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <div class="flex items-center flex-shrink-0">
                            <input id="item-2-delivered" type="checkbox" name="item-delivered-manual" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="item-2-delivered" class="text-sm font-medium text-gray-700">Manual interno / Guia rápido</label>
                        </div>
                        <input type="text" name="item-delivered-by-manual" placeholder="Entregue por quem?" class="mt-2 sm:mt-0 sm:ml-4 flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center">
                        <div class="flex items-center flex-shrink-0">
                            <input id="item-3-delivered" type="checkbox" name="item-delivered-email" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded mr-2">
                            <label for="item-3-delivered" class="text-sm font-medium text-gray-700">E-mail / Sistema liberado</label>
                        </div>
                        <input type="text" name="item-delivered-by-email" placeholder="Entregue por quem?" class="mt-2 sm:mt-0 sm:ml-4 flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                </div>
            </div>

            <!-- Seção 5: Avaliação do Treinamento -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-star mr-2"></i>Avaliação do Treinamento – 1ª Semana</h2>
                <div class="space-y-4">
                    <!-- Pergunta 1 -->
                    <fieldset>
                        <legend class="text-sm font-medium text-gray-700">O colaborador compreendeu as principais funções da sua atividade?</legend>
                        <div class="mt-2 flex items-center space-x-6">
                            <div class="flex items-center">
                                <input id="compreendeu-sim" name="compreensao" type="radio" value="Sim" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="compreendeu-sim" class="ml-2 block text-sm font-medium text-gray-700">Sim</label>
                            </div>
                            <div class="flex items-center">
                                <input id="compreendeu-parcialmente" name="compreensao" type="radio" value="Parcialmente" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="compreendeu-parcialmente" class="ml-2 block text-sm font-medium text-gray-700">Parcialmente</label>
                            </div>
                            <div class="flex items-center">
                                <input id="compreendeu-nao" name="compreensao" type="radio" value="Não" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="compreendeu-nao" class="ml-2 block text-sm font-medium text-gray-700">Não</label>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Pergunta 2 -->
                    <fieldset>
                        <legend class="text-sm font-medium text-gray-700">Mostrou-se engajado(a) e proativo(a) durante o período?</legend>
                        <div class="mt-2 flex items-center space-x-6">
                            <div class="flex items-center">
                                <input id="engajado-sim" name="engajamento" type="radio" value="Sim" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="engajado-sim" class="ml-2 block text-sm font-medium text-gray-700">Sim</label>
                            </div>
                            <div class="flex items-center">
                                <input id="engajado-parcialmente" name="engajamento" type="radio" value="Parcialmente" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="engajado-parcialmente" class="ml-2 block text-sm font-medium text-gray-700">Parcialmente</label>
                            </div>
                            <div class="flex items-center">
                                <input id="engajado-nao" name="engajamento" type="radio" value="Não" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                <label for="engajado-nao" class="ml-2 block text-sm font-medium text-gray-700">Não</label>
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Comentários do Líder -->
                    <div>
                        <label for="leader-comments" class="block text-sm font-medium text-gray-700">Comentários do líder</label>
                        <textarea id="leader-comments" name="leader-comments" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border"></textarea>
                    </div>
                </div>
            </div>

            <!-- Seção 6: Assinaturas Finais -->
            <div>
                <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-signature mr-2"></i>Assinaturas Finais</h2>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    <div>
                        <label for="leader-signature" class="block text-sm font-medium text-gray-700">Líder / Padrinho</label>
                        <input type="text" id="leader-signature" name="leader-signature" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="collaborator-signature" class="block text-sm font-medium text-gray-700">Colaborador (Formado)</label>
                        <input type="text" id="collaborator-signature" name="collaborator-signature" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                    <div>
                        <label for="hr-signature" class="block text-sm font-medium text-gray-700">Recursos Humanos</label>
                        <input type="text" id="hr-signature" name="hr-signature" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                    </div>
                </div>
            </div>

            <!-- Botão para Submeter os Dados -->
            <div class="flex justify-center mt-10">
                <button type="button" id="submit-button" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-indigo-400" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> Submeter Formulário
                </button>
            </div>
            <div id="status-message" class="mt-4 text-center text-sm font-medium text-gray-700">A carregar...</div>
        </form>

        <!-- Seção de Visualização dos Formulários Submetidos -->
        <div id="admin-view" class="w-full max-w-4xl hidden">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-indigo-800 mb-6">Painel de Administrador</h1>
            
            <!-- Menu de Administração -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
                <button class="menu-btn px-6 py-3 rounded-full text-base font-medium shadow-sm transition duration-300 ease-in-out transform hover:scale-105 bg-indigo-600 text-white" data-target="forms-submitted-section">Ver Formulários</button>
                <button class="menu-btn px-6 py-3 rounded-full text-base font-medium shadow-sm transition duration-300 ease-in-out transform hover:scale-105 bg-white text-indigo-600 border border-indigo-600" data-target="manage-topics-section">Gerir Tópicos</button>
                <button class="menu-btn px-6 py-3 rounded-full text-base font-medium shadow-sm transition duration-300 ease-in-out transform hover:scale-105 bg-white text-indigo-600 border border-indigo-600" data-target="reports-section">Relatórios</button>
            </div>
            
            <!-- Conteúdo do Menu -->
            <div id="forms-submitted-section" class="content-section">
                <p class="text-sm text-gray-600 mb-4">ID de Utilizador para partilha: <span id="user-id-display" class="font-mono bg-gray-200 rounded-md p-1 break-all"></span></p>
                <div id="forms-list" class="space-y-4">
                    <p class="text-center text-gray-500" id="loading-forms-message">A carregar dados...</p>
                </div>
            </div>

            <div id="manage-topics-section" class="content-section hidden">
                <div class="mt-12 bg-gray-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-edit mr-2"></i>Gerir Tópicos de Formação</h2>
                    <div id="admin-training-topics-list" class="space-y-4 mb-4">
                        <p class="text-center text-gray-500">A carregar tópicos...</p>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="new-topic-input" placeholder="Novo tópico de formação" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        <button id="add-topic-button" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>Adicionar
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="reports-section" class="content-section hidden">
                <div class="mt-12 bg-gray-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl sm:text-2xl font-bold text-indigo-700 border-b-2 border-indigo-200 pb-2 mb-4"><i class="fas fa-chart-bar mr-2"></i>Relatórios de Formulários</h2>
                    <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-grow w-full">
                            <label for="start-date" class="block text-sm font-medium text-gray-700">Data de Início</label>
                            <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </div>
                        <div class="flex-grow w-full">
                            <label for="end-date" class="block text-sm font-medium text-gray-700">Data de Fim</label>
                            <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                        </div>
                        <button id="generate-report-button" class="w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out transform hover:scale-105">
                            <i class="fas fa-file-excel mr-2"></i>Gerar Relatório (XLS)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, serverTimestamp, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis de ambiente fornecidas pelo Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        const ADMIN_ID = "admin_user_id";
        const ADMIN_USERNAME = "Admin";
        const ADMIN_PASSWORD = "Admin123";

        const loginContainer = document.getElementById('login-container');
        const formContainer = document.getElementById('form-container');
        const adminView = document.getElementById('admin-view');
        const trainingTopicsList = document.getElementById('training-topics-list');
        const adminTrainingTopicsList = document.getElementById('admin-training-topics-list');
        const submitButton = document.getElementById('submit-button');
        const statusMessage = document.getElementById('status-message');


        // Autenticação e inicialização
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated as user:", userId);
                        submitButton.disabled = false;
                        statusMessage.textContent = 'Autenticação concluída. Pode submeter o formulário.';
                    } else {
                        console.log("No user is signed in.");
                    }
                });

                // Carrega os tópicos de formação para o formulário do colaborador
                loadTrainingTopicsForCollaborator();
            } catch (e) {
                console.error("Error during Firebase initialization:", e);
                statusMessage.textContent = 'Erro de inicialização do Firebase. Por favor, atualize a página.';
                submitButton.disabled = true;
            }
        }
        
        // Carrega os tópicos de formação para o formulário do colaborador
        function loadTrainingTopicsForCollaborator() {
            const topicsRef = collection(db, `/artifacts/${appId}/public/data/training_topics`);
            onSnapshot(topicsRef, (snapshot) => {
                const fragment = document.createDocumentFragment();
                if (snapshot.empty) {
                    const p = document.createElement('p');
                    p.classList.add('text-center', 'text-gray-500');
                    p.textContent = 'Nenhum tópico de formação disponível. Por favor, contacte o seu administrador.';
                    fragment.appendChild(p);
                } else {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.classList.add('flex', 'items-start');
                        div.innerHTML = `
                            <div class="flex items-center h-5 mt-1">
                                <input id="topic-${doc.id}" type="checkbox" name="training_topics" value="${data.name}" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="topic-${doc.id}" class="font-medium text-gray-700">${data.name}</label>
                            </div>
                        `;
                        fragment.appendChild(div);
                    });
                }
                trainingTopicsList.innerHTML = '';
                trainingTopicsList.appendChild(fragment);
            });
        }

        // Lida com o login do utilizador
        document.getElementById('login-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                // Autenticação de Admin
                loginContainer.classList.add('hidden');
                formContainer.classList.add('hidden');
                adminView.classList.remove('hidden');
                document.body.classList.add('bg-gray-100');
                document.body.classList.remove('flex', 'items-center', 'justify-center');
                setupFirestoreListenerForAdmin();
                loadAdminTrainingTopics();
            } else {
                alert("Credenciais de administrador inválidas. O acesso está bloqueado.");
            }
        });
        
        // Lidar com a entrada do colaborador
        document.getElementById('collaborator-button').addEventListener('click', async function(event) {
            event.preventDefault();
            loginContainer.classList.add('hidden');
            formContainer.classList.remove('hidden');
            adminView.classList.add('hidden');
            statusMessage.textContent = 'Aguarde, a aplicação está a ser inicializada...';
        });

        // Event listener para o menu de administração
        document.querySelectorAll('.menu-btn').forEach(button => {
            button.addEventListener('click', function() {
                // Remove a classe de estilo ativo de todos os botões e esconde todas as seções
                document.querySelectorAll('.menu-btn').forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white');
                    btn.classList.add('bg-white', 'text-indigo-600', 'border', 'border-indigo-600');
                });
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.add('hidden');
                });

                // Adiciona a classe de estilo ativo ao botão clicado e mostra a seção correspondente
                this.classList.add('bg-indigo-600', 'text-white');
                this.classList.remove('bg-white', 'text-indigo-600', 'border', 'border-indigo-600');
                document.getElementById(this.dataset.target).classList.remove('hidden');
            });
        });

        // Configura o listener do Firestore para a base de dados do Admin
        function setupFirestoreListenerForAdmin() {
            const formsRef = collection(db, `/artifacts/${appId}/public/data/training_forms`);
            onSnapshot(formsRef, (snapshot) => {
                const formsList = document.getElementById('forms-list');
                formsList.innerHTML = '';
                if (snapshot.empty) {
                    formsList.innerHTML = '<p class="text-center text-gray-500">Nenhum formulário submetido ainda.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const formItem = document.createElement('div');
                        formItem.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200', 'flex', 'flex-col', 'sm:flex-row', 'items-center', 'justify-between');
                        formItem.innerHTML = `
                            <div class="flex-grow mb-4 sm:mb-0">
                                <p class="font-bold text-lg text-indigo-700">${data.name}</p>
                                <p class="text-sm text-gray-600">Admissão: ${data['admission-date']}</p>
                                <p class="text-sm text-gray-600">Cargo: ${data.position}</p>
                            </div>
                            <button class="export-button px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition duration-300 ease-in-out transform hover:scale-105" data-doc-id="${doc.id}">
                                <i class="fas fa-file-excel mr-2"></i>Exportar para Excel
                            </button>
                        `;
                        formsList.appendChild(formItem);
                    });
                }
            });
        }
        
        // Função para carregar os tópicos de formação para a aba de administrador
        function loadAdminTrainingTopics() {
            const topicsRef = collection(db, `/artifacts/${appId}/public/data/training_topics`);
            onSnapshot(topicsRef, (snapshot) => {
                adminTrainingTopicsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.classList.add('flex', 'items-center', 'justify-between', 'bg-white', 'p-3', 'rounded-md', 'shadow-sm');
                    item.innerHTML = `
                        <input type="text" value="${data.name}" data-doc-id="${doc.id}" class="flex-grow mr-4 p-2 rounded-md border border-gray-300 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                        <div>
                            <button class="delete-topic-button text-red-500 hover:text-red-700 transition" data-doc-id="${doc.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    adminTrainingTopicsList.appendChild(item);
                });
            });
        }

        // Função para exportar um formulário individualmente
        document.addEventListener('click', async function(event) {
            if (event.target.classList.contains('export-button')) {
                const docId = event.target.getAttribute('data-doc-id');
                const formsRef = collection(db, `/artifacts/${appId}/public/data/training_forms`);
                const formDoc = doc(formsRef, docId);
                const docSnap = await getDoc(formDoc);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Converte os dados para um formato CSV
                    let csvContent = "";
                    const headers = Object.keys(data).join(";");
                    const values = Object.values(data).map(value => {
                        if (Array.isArray(value)) {
                            return `"${value.join(', ')}"`;
                        }
                        if (typeof value === 'object' && value !== null) {
                            return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                        }
                        return `"${value}"`;
                    }).join(";");
                    csvContent += headers + "\n" + values;

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `formulario_${docId}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert("Documento não encontrado.");
                }
            }
        });

        // Adicionar novo tópico de formação
        document.getElementById('add-topic-button').addEventListener('click', async function() {
            const newTopicInput = document.getElementById('new-topic-input');
            const topicName = newTopicInput.value.trim();
            if (topicName) {
                try {
                    const topicsRef = collection(db, `/artifacts/${appId}/public/data/training_topics`);
                    await addDoc(topicsRef, { name: topicName });
                    newTopicInput.value = '';
                } catch (e) {
                    console.error("Erro ao adicionar tópico: ", e);
                }
            }
        });

        // Deletar tópico de formação
        adminTrainingTopicsList.addEventListener('click', async function(event) {
            if (event.target.classList.contains('delete-topic-button')) {
                const docId = event.target.getAttribute('data-doc-id');
                try {
                    const topicsRef = collection(db, `/artifacts/${appId}/public/data/training_topics`);
                    await deleteDoc(doc(topicsRef, docId));
                } catch (e) {
                    console.error("Erro ao deletar tópico: ", e);
                }
            }
        });

        // Gerar relatório de formulários
        document.getElementById('generate-report-button').addEventListener('click', async function() {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;

            if (!startDate || !endDate) {
                alert("Por favor, selecione as datas de início e fim.");
                return;
            }

            const formsRef = collection(db, `/artifacts/${appId}/public/data/training_forms`);
            const q = query(formsRef, where("timestamp", ">=", new Date(startDate)), where("timestamp", "<=", new Date(endDate)));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("Nenhum formulário encontrado no período selecionado.");
                return;
            }

            let csvContent = "Nome;Data Admissão;Setor;Cargo\n";
            querySnapshot.forEach(doc => {
                const data = doc.data();
                const row = [data.name, data['admission-date'], data.sector, data.position].map(val => `"${val}"`).join(";");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `relatorio_${startDate}_${endDate}.xls`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Lidar com a submissão do formulário
        document.getElementById('submit-button').addEventListener('click', async function(event) {
            event.preventDefault(); 
            
            const form = document.getElementById('training-form');
            statusMessage.textContent = 'A submeter formulário...';
            
            const formData = new FormData(form);
            const data = {
                timestamp: serverTimestamp(),
            };

            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }

            const trainingTopics = [];
            form.querySelectorAll('input[name="training_topics"]:checked').forEach(cb => {
                trainingTopics.push(cb.value);
            });
            data.training_topics = trainingTopics;

            data['items_delivered'] = {
                'Cartão de ponto / Acesso': {
                    delivered: form.querySelector('input[name="item-delivered-cartao"]').checked,
                    by: form.querySelector('input[name="item-delivered-by-cartao"]').value,
                },
                'Manual interno / Guia rápido': {
                    delivered: form.querySelector('input[name="item-delivered-manual"]').checked,
                    by: form.querySelector('input[name="item-delivered-by-manual"]').value,
                },
                'E-mail / Sistema liberado': {
                    delivered: form.querySelector('input[name="item-delivered-email"]').checked,
                    by: form.querySelector('input[name="item-delivered-by-email"]').value,
                },
            };

            try {
                const formsRef = collection(db, `/artifacts/${appId}/public/data/training_forms`);
                await addDoc(formsRef, data);
                
                statusMessage.textContent = 'Formulário submetido com sucesso!';
                form.reset();
            } catch (e) {
                console.error("Error adding document: ", e);
                statusMessage.textContent = 'Erro ao submeter o formulário. Por favor, tente novamente.';
            }
        });

        // Inicia a aplicação
        initializeFirebase();
    </script>
</body>
</html>
